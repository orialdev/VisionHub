-- YARHM UI Library Remastered & Advanced
-- Fixed Bugs, Added Sliders/Dropdowns, Direct Instancing System

local Library = {}
local Components = {}

-- [[ Core Services ]]
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")

-- [[ Environment Setup ]]
local Viewport = (typeof(gethui) == "function" and gethui()) or CoreGui

-- [[ Theme Configuration ]]
Library.Theme = {
    Main = Color3.fromRGB(25, 25, 25),
    Secondary = Color3.fromRGB(35, 35, 35),
    Detail = Color3.fromRGB(45, 45, 45),
    Accent = Color3.fromRGB(200, 40, 40), -- The Red YARHM Accent
    Text = Color3.fromRGB(240, 240, 240),
    TextDark = Color3.fromRGB(150, 150, 150),
    Gradient1 = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(53,53,53)),
        ColorSequenceKeypoint.new(0.4, Color3.fromRGB(200,40,40)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(48,48,48))
    }
}

-- [[ Utility Functions ]]

local function Create(className, props)
    local instance = Instance.new(className)
    for k, v in pairs(props) do
        if k ~= "Parent" then instance[k] = v end
    end
    if props.Parent then instance.Parent = props.Parent end
    return instance
end

local function MakeDraggable(gui)
    local dragging
    local dragInput
    local dragStart
    local startPos

    local function update(input)
        local delta = input.Position - dragStart
        gui.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    gui.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = gui.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    gui.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

local function Ripple(Obj)
    task.spawn(function()
        local Clone = Create("ImageLabel", {
            Name = "Ripple",
            Parent = Obj,
            BackgroundTransparency = 1,
            Position = UDim2.new(0.5, 0, 0.5, 0),
            Size = UDim2.new(0, 0, 0, 0),
            Image = "rbxassetid://4560909609",
            ImageColor3 = Color3.fromRGB(200, 200, 200),
            ImageTransparency = 0.6,
            ZIndex = 2,
            AnchorPoint = Vector2.new(0.5, 0.5),
        })
        
        -- Animation
        local T1 = TweenService:Create(Clone, TweenInfo.new(0.5), {Size = UDim2.new(0, 300, 0, 300), ImageTransparency = 1})
        T1:Play()
        T1.Completed:Wait()
        Clone:Destroy()
    end)
end

-- [[ Window Creation ]]

function Library:CreateWindow(config)
    local WindowName = config.Name or "YARHM UI"
    local Internal = {Tabs = {}, CurrentTab = nil}

    -- > Main ScreenGui
    local ScreenGui = Create("ScreenGui", {
        Name = "YARHM_"..math.random(1, 100000),
        Parent = Viewport,
        IgnoreGuiInset = true,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    
    -- > Main Frame
    local MainFrame = Create("Frame", {
        Name = "Main",
        Parent = ScreenGui,
        BackgroundColor3 = Library.Theme.Main,
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 0, 0, 0), -- Animated opening
        ClipsDescendants = true,
        AnchorPoint = Vector2.new(0.5, 0.5)
    })
    
    Create("UICorner", {CornerRadius = UDim.new(0, 10), Parent = MainFrame})
    local MainStroke = Create("UIStroke", {Thickness = 2, Transparency = 0, Color = Color3.new(1,1,1), Parent = MainFrame})
    Create("UIGradient", {Color = Library.Theme.Gradient1, Rotation = 45, Parent = MainStroke})
    MakeDraggable(MainFrame)

    -- > Title Header
    local Header = Create("Frame", {
        Name = "Header",
        Parent = MainFrame,
        BackgroundColor3 = Library.Theme.Secondary,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 40)
    })
    Create("UICorner", {CornerRadius = UDim.new(0, 10), Parent = Header})
    -- Cover bottom rounded corners of header to make it flat on bottom
    Create("Frame", {
        Name = "HeaderFix", Parent = Header,
        BackgroundColor3 = Library.Theme.Secondary, BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 10), Position = UDim2.new(0,0,1,-10), ZIndex = 0
    })

    Create("TextLabel", {
        Name = "Title", Parent = Header,
        Text = WindowName, Font = Enum.Font.GothamBold, TextSize = 18,
        TextColor3 = Library.Theme.Text, BackgroundTransparency = 1,
        Size = UDim2.new(1, -20, 1, 0), Position = UDim2.new(0, 20, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- > Content Layout (Left Sidebar for Tabs, Right for Content)
    local Sidebar = Create("ScrollingFrame", {
        Name = "Sidebar",
        Parent = MainFrame,
        BackgroundColor3 = Library.Theme.Secondary,
        BackgroundTransparency = 1, -- Blends with Main
        BorderSizePixel = 0,
        Size = UDim2.new(0, 130, 1, -50),
        Position = UDim2.new(0, 10, 0, 45),
        ScrollBarThickness = 2,
        CanvasSize = UDim2.new(), -- Auto
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })
    Create("UIListLayout", {Padding = UDim.new(0, 5), SortOrder = Enum.SortOrder.LayoutOrder, Parent = Sidebar})
    
    local ContentContainer = Create("Frame", {
        Name = "Content",
        Parent = MainFrame,
        BackgroundColor3 = Color3.new(0,0,0), BackgroundTransparency = 1,
        Size = UDim2.new(1, -155, 1, -50),
        Position = UDim2.new(0, 150, 0, 45)
    })

    -- Opening Animation
    TweenService:Create(MainFrame, TweenInfo.new(0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 550, 0, 350)
    }):Play()


    -- [[ Tab Logic ]] --

    function Internal:CreateTab(TabName)
        local Tab = {}
        
        -- Create Sidebar Button
        local TabBtn = Create("TextButton", {
            Name = TabName.."Btn",
            Parent = Sidebar,
            BackgroundColor3 = Library.Theme.Detail,
            Text = TabName,
            Font = Enum.Font.GothamMedium,
            TextColor3 = Library.Theme.TextDark,
            TextSize = 13,
            Size = UDim2.new(1, -4, 0, 35),
            AutoButtonColor = false
        })
        Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = TabBtn})
        
        -- Create Tab Frame
        local TabFrame = Create("ScrollingFrame", {
            Name = TabName.."Page",
            Parent = ContentContainer,
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            ScrollBarThickness = 3,
            Visible = false,
            AutomaticCanvasSize = Enum.AutomaticSize.Y,
            CanvasSize = UDim2.new()
        })
        Create("UIListLayout", {Padding = UDim.new(0, 8), SortOrder = Enum.SortOrder.LayoutOrder, HorizontalAlignment = Enum.HorizontalAlignment.Center, Parent = TabFrame})
        Create("UIPadding", {PaddingTop = UDim.new(0, 2), PaddingBottom = UDim.new(0, 10), Parent = TabFrame})

        -- Activate Logic
        TabBtn.MouseButton1Click:Connect(function()
            -- Deactivate old tabs
            for _, btn in pairs(Sidebar:GetChildren()) do
                if btn:IsA("TextButton") then
                    TweenService:Create(btn, TweenInfo.new(0.3), {TextColor3 = Library.Theme.TextDark, BackgroundColor3 = Library.Theme.Detail}):Play()
                end
            end
            for _, pg in pairs(ContentContainer:GetChildren()) do if pg:IsA("ScrollingFrame") then pg.Visible = false end end

            -- Activate new tab
            TabFrame.Visible = true
            TweenService:Create(TabBtn, TweenInfo.new(0.3), {TextColor3 = Library.Theme.Text, BackgroundColor3 = Library.Theme.Accent}):Play()
        end)

        -- If this is the first tab, select it
        if not Internal.CurrentTab then
            Internal.CurrentTab = TabBtn
            TabBtn.TextColor3 = Library.Theme.Text
            TabBtn.BackgroundColor3 = Library.Theme.Accent
            TabFrame.Visible = true
        end


        -- [[ Elements ]] --

        function Tab:CreateLabel(Text)
            local Labl = Create("TextLabel", {
                Name = "Label", Parent = TabFrame,
                BackgroundTransparency = 1,
                Text = Text,
                TextColor3 = Library.Theme.Text,
                Font = Enum.Font.GothamBold,
                TextSize = 14,
                Size = UDim2.new(1, 0, 0, 25),
                TextXAlignment = Enum.TextXAlignment.Left
            })
            Create("UIPadding", {PaddingLeft = UDim.new(0,10), Parent = Labl})
            return Labl
        end

        function Tab:CreateButton(Text, Callback)
            Callback = Callback or function() end
            local Button = Create("TextButton", {
                Name = "Button", Parent = TabFrame,
                BackgroundColor3 = Library.Theme.Detail,
                Text = "",
                Size = UDim2.new(1, -5, 0, 32),
                AutoButtonColor = false,
                ClipsDescendants = true
            })
            Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = Button})
            Create("TextLabel", {
                Parent = Button, Text = Text, BackgroundTransparency = 1,
                TextColor3 = Library.Theme.Text, Font = Enum.Font.GothamMedium, TextSize = 13,
                Size = UDim2.new(1, 0, 1, 0)
            })
            
            Button.MouseButton1Click:Connect(function()
                Ripple(Button)
                pcall(Callback)
            end)
        end

        function Tab:CreateToggle(Text, Default, Callback)
            Callback = Callback or function() end
            local state = Default or false
            
            local ToggleFrame = Create("TextButton", {
                Name = "Toggle", Parent = TabFrame,
                BackgroundColor3 = Library.Theme.Detail,
                Text = "", Size = UDim2.new(1, -5, 0, 35),
                AutoButtonColor = false
            })
            Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = ToggleFrame})
            
            local Label = Create("TextLabel", {
                Parent = ToggleFrame, Text = Text,
                TextColor3 = Library.Theme.Text, Font = Enum.Font.GothamMedium, TextSize = 13,
                Size = UDim2.new(0.7, 0, 1, 0), Position = UDim2.new(0, 10, 0, 0),
                BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left
            })

            local ToggleBg = Create("Frame", {
                Parent = ToggleFrame,
                BackgroundColor3 = (state and Library.Theme.Accent) or Color3.fromRGB(30, 30, 30),
                Size = UDim2.new(0, 40, 0, 20),
                Position = UDim2.new(1, -50, 0.5, 0),
                AnchorPoint = Vector2.new(0, 0.5)
            })
            Create("UICorner", {CornerRadius = UDim.new(1, 0), Parent = ToggleBg})
            
            local ToggleDot = Create("Frame", {
                Parent = ToggleBg,
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                Size = UDim2.new(0, 16, 0, 16),
                Position = UDim2.new(0, (state and 22) or 2, 0.5, 0),
                AnchorPoint = Vector2.new(0, 0.5)
            })
            Create("UICorner", {CornerRadius = UDim.new(1, 0), Parent = ToggleDot})

            local function Update()
                state = not state
                local GoalPos = state and 22 or 2
                local GoalCol = state and Library.Theme.Accent or Color3.fromRGB(30, 30, 30)
                
                TweenService:Create(ToggleDot, TweenInfo.new(0.2), {Position = UDim2.new(0, GoalPos, 0.5, 0)}):Play()
                TweenService:Create(ToggleBg, TweenInfo.new(0.2), {BackgroundColor3 = GoalCol}):Play()
                pcall(Callback, state)
            end

            ToggleFrame.MouseButton1Click:Connect(Update)
            
            -- If Default was true, ensure Visuals are set correctly without triggering callback again or setup logic
            -- (Handled by construction logic above)
        end

        function Tab:CreateSlider(Text, Min, Max, Default, Callback)
            Callback = Callback or function() end
            local dragging = false

            local SliderFrame = Create("Frame", {
                Name = "Slider", Parent = TabFrame,
                BackgroundColor3 = Library.Theme.Detail,
                Size = UDim2.new(1, -5, 0, 50)
            })
            Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = SliderFrame})

            Create("TextLabel", {
                Parent = SliderFrame, Text = Text,
                TextColor3 = Library.Theme.Text, Font = Enum.Font.GothamMedium, TextSize = 13,
                Size = UDim2.new(1, -20, 0, 25), Position = UDim2.new(0, 10, 0, 0),
                BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left
            })

            local ValueLabel = Create("TextLabel", {
                Parent = SliderFrame, Text = tostring(Default),
                TextColor3 = Library.Theme.TextDark, Font = Enum.Font.Gotham, TextSize = 12,
                Size = UDim2.new(0, 50, 0, 25), Position = UDim2.new(1, -60, 0, 0),
                BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Right
            })

            local Track = Create("Frame", {
                Name = "Track", Parent = SliderFrame,
                BackgroundColor3 = Color3.fromRGB(30, 30, 30),
                Size = UDim2.new(1, -20, 0, 6),
                Position = UDim2.new(0, 10, 0, 35)
            })
            Create("UICorner", {CornerRadius = UDim.new(1, 0), Parent = Track})

            local Fill = Create("Frame", {
                Name = "Fill", Parent = Track,
                BackgroundColor3 = Library.Theme.Accent,
                Size = UDim2.new((Default - Min)/(Max - Min), 0, 1, 0),
            })
            Create("UICorner", {CornerRadius = UDim.new(1, 0), Parent = Fill})

            local Knob = Create("Frame", { -- Hitbox for dragging
                Parent = Track, BackgroundTransparency = 1,
                Size = UDim2.new(1, 10, 1, 20), Position = UDim2.new(0, -5, 0.5, 0), AnchorPoint = Vector2.new(0, 0.5)
            })

            local function Update(Input)
                local SizeX = math.clamp((Input.Position.X - Track.AbsolutePosition.X) / Track.AbsoluteSize.X, 0, 1)
                local NewValue = math.floor(Min + ((Max - Min) * SizeX))
                
                ValueLabel.Text = tostring(NewValue)
                TweenService:Create(Fill, TweenInfo.new(0.05), {Size = UDim2.new(SizeX, 0, 1, 0)}):Play()
                pcall(Callback, NewValue)
            end

            Knob.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    Update(input)
                end
            end)

            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
            end)

            UserInputService.InputChanged:Connect(function(input)
                if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    Update(input)
                end
            end)
        end

        function Tab:CreateDropdown(Text, Items, Callback)
            Callback = Callback or function() end
            local Expanded = false

            local Container = Create("Frame", {
                Name = "Dropdown", Parent = TabFrame,
                BackgroundColor3 = Library.Theme.Detail,
                Size = UDim2.new(1, -5, 0, 35),
                ClipsDescendants = true
            })
            Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = Container})

            local TitleBtn = Create("TextButton", {
                Parent = Container, Text = "",
                BackgroundTransparency = 1, Size = UDim2.new(1, 0, 0, 35),
                ZIndex = 2
            })
            
            Create("TextLabel", {
                Parent = TitleBtn, Text = Text,
                TextColor3 = Library.Theme.Text, Font = Enum.Font.GothamMedium, TextSize = 13,
                Size = UDim2.new(1, -40, 1, 0), Position = UDim2.new(0, 10, 0, 0),
                BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left
            })

            local Arrow = Create("ImageLabel", {
                Parent = TitleBtn, Image = "rbxassetid://6034818372",
                Size = UDim2.new(0, 20, 0, 20), Position = UDim2.new(1, -30, 0.5, -10),
                BackgroundTransparency = 1, ImageColor3 = Library.Theme.TextDark
            })

            local ListLayout = Create("UIListLayout", {
                Parent = Container, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 2)
            })

            -- Create Spacing for header
            local PadFrame = Create("Frame", {Name="Padding", Parent = Container, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,35), LayoutOrder = -1})
            
            -- Content Refresh
            local function RefreshItems()
                for _, child in ipairs(Container:GetChildren()) do
                    if child:IsA("TextButton") and child ~= TitleBtn then child:Destroy() end
                end

                for i, v in ipairs(Items) do
                    local ItemBtn = Create("TextButton", {
                        Name = v, Parent = Container,
                        BackgroundColor3 = Color3.fromRGB(35, 35, 35),
                        Text = v, TextColor3 = Library.Theme.TextDark,
                        Font = Enum.Font.Gotham, TextSize = 13,
                        Size = UDim2.new(1, -10, 0, 25),
                        Position = UDim2.new(0, 5, 0, 0)
                    })
                    Create("UICorner", {CornerRadius = UDim.new(0, 4), Parent = ItemBtn})
                    
                    ItemBtn.MouseButton1Click:Connect(function()
                        -- Update Header Text?
                        -- Create("TextLabel") inside header usually shows selection
                        pcall(Callback, v)
                        
                        -- Collapse
                        Expanded = false
                        TweenService:Create(Container, TweenInfo.new(0.3), {Size = UDim2.new(1, -5, 0, 35)}):Play()
                        TweenService:Create(Arrow, TweenInfo.new(0.3), {Rotation = 0}):Play()
                    end)
                end
            end
            
            RefreshItems()

            TitleBtn.MouseButton1Click:Connect(function()
                Expanded = not Expanded
                local Height = 35 + (Expanded and (#Items * 27) + 5 or 0)
                
                TweenService:Create(Arrow, TweenInfo.new(0.3), {Rotation = Expanded and 180 or 0}):Play()
                TweenService:Create(Container, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                    Size = UDim2.new(1, -5, 0, Height)
                }):Play()
            end)
        end
        
        function Tab:CreateInput(Text, Placeholder, Callback)
             Callback = Callback or function() end
             
             local InputFrame = Create("Frame", {
                 Name = "Input", Parent = TabFrame,
                 BackgroundColor3 = Library.Theme.Detail,
                 Size = UDim2.new(1, -5, 0, 40)
             })
             Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = InputFrame})
             
             Create("TextLabel", {
                 Parent = InputFrame, Text = Text,
                 TextColor3 = Library.Theme.Text, Font = Enum.Font.GothamMedium, TextSize = 13,
                 Size = UDim2.new(0.4, 0, 1, 0), Position = UDim2.new(0, 10, 0, 0),
                 BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left
             })
             
             local TextBox = Create("TextBox", {
                 Parent = InputFrame, BackgroundColor3 = Color3.fromRGB(30,30,30),
                 TextColor3 = Library.Theme.Text, PlaceholderText = Placeholder or "Type here...",
                 Text = "", Font = Enum.Font.Gotham, TextSize = 13,
                 Size = UDim2.new(0.55, 0, 0, 26), Position = UDim2.new(0.43, 0, 0.5, 0),
                 AnchorPoint = Vector2.new(0, 0.5)
             })
             Create("UICorner", {CornerRadius = UDim.new(0, 4), Parent = TextBox})
             
             TextBox.FocusLost:Connect(function(enter)
                 if enter then
                     pcall(Callback, TextBox.Text)
                 end
             end)
        end

        return Tab
    end
    
    -- [[ Notification System ]]
    
    function Internal:Notify(Config)
        local Title = Config.Title or "Notification"
        local Content = Config.Content or "Message"
        local Duration = Config.Duration or 3

        local NotifFrame = Create("Frame", {
            Name = "Notif", Parent = ScreenGui,
            BackgroundColor3 = Library.Theme.Main,
            BorderSizePixel = 0,
            Size = UDim2.new(0, 250, 0, 80),
            Position = UDim2.new(1, 10, 1, -20 - (85 * (#ScreenGui:GetChildren() - 1))), -- Right side spawn
            AnchorPoint = Vector2.new(0, 1)
        })
        Create("UICorner", {CornerRadius = UDim.new(0, 8), Parent = NotifFrame})
        local Stroke = Create("UIStroke", {Parent = NotifFrame, Color = Library.Theme.Accent, Thickness = 1})

        local LblTitle = Create("TextLabel", {
            Parent = NotifFrame, Text = Title, Font = Enum.Font.GothamBold,
            TextSize = 14, TextColor3 = Library.Theme.Accent,
            Position = UDim2.new(0, 10, 0, 8), Size = UDim2.new(1, -20, 0, 20),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left
        })

        local LblContent = Create("TextLabel", {
            Parent = NotifFrame, Text = Content, Font = Enum.Font.Gotham,
            TextSize = 13, TextColor3 = Library.Theme.Text,
            Position = UDim2.new(0, 10, 0, 30), Size = UDim2.new(1, -20, 0, 40),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left,
            TextWrapped = true
        })

        -- Animate In
        TweenService:Create(NotifFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
            Position = UDim2.new(1, -260, 1, NotifFrame.Position.Y.Offset)
        }):Play()

        -- Remove
        task.spawn(function()
            task.wait(Duration)
            local Out = TweenService:Create(NotifFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
                Position = UDim2.new(1, 10, 1, NotifFrame.Position.Y.Offset)
            })
            Out:Play()
            Out.Completed:Wait()
            NotifFrame:Destroy()
        end)
    end
    
    -- Store library interface
    Library.Notify = function(_, config) Internal:Notify(config) end

    return Internal
end

return Library
